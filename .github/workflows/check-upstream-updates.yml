name: Check Upstream Updates

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  load-config:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Read upstream-config.yml and generate matrix
        id: set-matrix
        run: |
          MATRIX=$(yq -o=json '.cogs | to_entries | map(select(.value != null)) | map({
            "name": .key,
            "upstream": .value.upstream,
            "path": .value.path,
            "branch": .value.branch
          })' .github/upstream-config.yml | jq -c '{cog: .}')
          
          echo "Generated matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  check-updates:
    runs-on: ubuntu-latest
    needs: load-config
    if: ${{ needs.load-config.outputs.matrix != '' && needs.load-config.outputs.matrix != '{"cog":[]}' }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    strategy:
      matrix: ${{ fromJson(needs.load-config.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add Upstream Remote
        id: remote
        run: |
          git remote add upstream-${{ matrix.cog.name }} ${{ matrix.cog.upstream }} 2>/dev/null || true
          
          if ! git fetch upstream-${{ matrix.cog.name }} 2>&1; then
            echo "fetch_failed=true" >> $GITHUB_OUTPUT
            echo "::error::Failed to fetch from upstream: ${{ matrix.cog.upstream }}"
            exit 0
          fi
          
          echo "fetch_failed=false" >> $GITHUB_OUTPUT

      - name: Check for Updates
        id: check
        if: steps.remote.outputs.fetch_failed != 'true'
        run: |
          UPSTREAM_BRANCH="${{ matrix.cog.branch }}"
          if [ -z "$UPSTREAM_BRANCH" ]; then
            UPSTREAM_BRANCH=$(git ls-remote --symref upstream-${{ matrix.cog.name }} HEAD | head -n 1 | awk '{print $2}' | sed 's/refs\/heads\///')
            if [ -z "$UPSTREAM_BRANCH" ]; then
              UPSTREAM_BRANCH="main"
            fi
          fi
          
          echo "upstream_branch=$UPSTREAM_BRANCH" >> $GITHUB_OUTPUT
          
          if ! git rev-parse --verify "upstream-${{ matrix.cog.name }}/$UPSTREAM_BRANCH" >/dev/null 2>&1; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "error=Upstream branch '$UPSTREAM_BRANCH' not found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if ! git ls-tree -r upstream-${{ matrix.cog.name }}/$UPSTREAM_BRANCH --name-only | grep -q "^${{ matrix.cog.path }}/"; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "error=Upstream path not found" >> $GITHUB_OUTPUT
            exit 0
          fi

          UPSTREAM_PATH_SHA=$(git log -n 1 --format=%H upstream-${{ matrix.cog.name }}/$UPSTREAM_BRANCH -- ${{ matrix.cog.path }}/)
          if [ -z "$UPSTREAM_PATH_SHA" ]; then
            UPSTREAM_PATH_SHA=$(git rev-parse "upstream-${{ matrix.cog.name }}/$UPSTREAM_BRANCH")
          fi
          echo "upstream_path_sha=$UPSTREAM_PATH_SHA" >> $GITHUB_OUTPUT

          STATE_FILE=".github/upstream-state/${{ matrix.cog.name }}.sha"
          LAST_SYNCED_SHA=""
          if [ -f "$STATE_FILE" ]; then
            LAST_SYNCED_SHA=$(head -n 1 "$STATE_FILE" | tr -d '[:space:]')
          fi
          echo "last_synced_sha=$LAST_SYNCED_SHA" >> $GITHUB_OUTPUT

          if [ "$UPSTREAM_PATH_SHA" = "$LAST_SYNCED_SHA" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "::notice::No new upstream commit for ${{ matrix.cog.name }} ($UPSTREAM_PATH_SHA)"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Update Branch
        if: steps.check.outputs.has_updates == 'true'
        id: branch
        run: |
          BRANCH_NAME="update/${{ matrix.cog.name }}-upstream"
          git checkout -B $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Merge Upstream Changes
        if: steps.check.outputs.has_updates == 'true'
        id: merge
        continue-on-error: true
        run: |
          UPSTREAM_BRANCH=${{ steps.check.outputs.upstream_branch }}
          
          echo "Merging changes from upstream..."
          
          git merge --no-commit --no-ff --allow-unrelated-histories \
            upstream-${{ matrix.cog.name }}/$UPSTREAM_BRANCH || echo "merge_conflict=true" >> $GITHUB_OUTPUT
          
          echo "Isolating changes to ${{ matrix.cog.path }}..."
          
          git reset HEAD
          
          git checkout HEAD -- . ":!${{ matrix.cog.path }}"
          
          git clean -fd -e "${{ matrix.cog.path }}/"
          
          STATE_DIR=".github/upstream-state"
          STATE_FILE="$STATE_DIR/${{ matrix.cog.name }}.sha"
          mkdir -p "$STATE_DIR"
          echo "${{ steps.check.outputs.upstream_path_sha }}" > "$STATE_FILE"

          git add ${{ matrix.cog.path }}/
          git add "$STATE_FILE"
          
          if grep -r "^<<<<<<< " ${{ matrix.cog.path }}/; then
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            echo "has_effective_changes=true" >> $GITHUB_OUTPUT
            
            CONFLICT_FILES=$(grep -l -r "^<<<<<<< " ${{ matrix.cog.path }}/ | tr '\n' ', ' | sed 's/,$//')
            echo "conflict_files=$CONFLICT_FILES" >> $GITHUB_OUTPUT
            
            git commit -m "‚ö†Ô∏è Update ${{ matrix.cog.name }} from upstream (with conflicts)" -m "Conflicts in: $CONFLICT_FILES"
          else
            if ! git diff --cached --quiet; then
              echo "has_conflicts=false" >> $GITHUB_OUTPUT
              echo "has_effective_changes=true" >> $GITHUB_OUTPUT
              git commit -m "‚úÖ Update ${{ matrix.cog.name }} from upstream"
            else
               echo "No effective changes after filtering"
               echo "has_effective_changes=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Push Changes
        if: steps.check.outputs.has_updates == 'true' && steps.merge.outputs.has_effective_changes == 'true'
        run: |
          git push -f origin ${{ steps.branch.outputs.branch_name }}

      - name: Ensure Labels Exist
        if: steps.check.outputs.has_updates == 'true' && steps.merge.outputs.has_effective_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh label create upstream-update --color 3fb542 --description "From upstream update" || true
          gh label create automated --color ededed --description "Automated PR" || true
          gh label create merge-conflict --color d73a4a --description "Has merge conflicts" || true

      - name: Check Existing Pull Request
        if: steps.check.outputs.has_updates == 'true' && steps.merge.outputs.has_effective_changes == 'true'
        id: existing-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_URL=$(gh pr list \
            --state open \
            --base main \
            --head ${{ steps.branch.outputs.branch_name }} \
            --json url \
            --jq '.[0].url // empty')
          
          if [ -n "$PR_URL" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "url=$PR_URL" >> $GITHUB_OUTPUT
            echo "::notice::PR already exists: $PR_URL"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has_updates == 'true' && steps.merge.outputs.has_effective_changes == 'true' && steps.existing-pr.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          HAS_CONFLICTS="${{ steps.merge.outputs.has_conflicts }}"
          CONFLICT_FILES="${{ steps.merge.outputs.conflict_files }}"
          
          if [ "$HAS_CONFLICTS" = "true" ]; then
            TITLE="‚ö†Ô∏è Update ${{ matrix.cog.name }} from upstream (Conflicts)"
            LABELS="upstream-update,automated,merge-conflict"
            
            cat > pr_body.md <<'EOF'
          ## Ëá™ÂãïÊõ¥Êñ∞ ${{ matrix.cog.name }}
          
          Ê≠§ PR Áî± GitHub Actions Ëá™ÂãïÂâµÂª∫ÔºåÂæû‰∏äÊ∏∏ÂÄâÂ∫´Êõ¥Êñ∞ cog„ÄÇ
          
          **‰∏äÊ∏∏ÂÄâÂ∫´**: ${{ matrix.cog.upstream }}
          **ÂàÜÊîØ**: ${{ steps.check.outputs.upstream_branch }}
          **Ë∑ØÂæë**: ${{ matrix.cog.path }}
          
          ## ‚ö†Ô∏è Âêà‰ΩµË°ùÁ™Å
          
          Ê≠§Êõ¥Êñ∞ÂåÖÂê´Âêà‰ΩµË°ùÁ™ÅÔºåÈúÄË¶ÅÊâãÂãïËß£Ê±∫„ÄÇ
          
          **Ë°ùÁ™ÅÊ™îÊ°à**: CONFLICT_FILES_PLACEHOLDER
          
          ### üîß Ëß£Ê±∫Ê≠•È©ü
          
          1. Checkout ÈÄôÂÄãÂàÜÊîØÔºö
          ```bash
          git fetch origin
          git checkout BRANCH_NAME_PLACEHOLDER
          ```
          
          2. Ëß£Ê±∫Ë°ùÁ™ÅÊ™îÊ°à‰∏≠ÁöÑË°ùÁ™ÅÊ®ôË®òÔºö
             - ÈñãÂïüÊúâË°ùÁ™ÅÁöÑÊ™îÊ°à
             - Â∞ãÊâæ \`<<<<<<<\`, \`=======\`, \`>>>>>>>\` Ê®ôË®ò
             - Ê±∫ÂÆö‰øùÁïôÂì™‰∫õËÆäÊõ¥
             - ÁßªÈô§Ë°ùÁ™ÅÊ®ôË®ò
          
          3. ÂÆåÊàêËß£Ê±∫Ôºö
          ```bash
          git add .
          git commit -m "Resolve merge conflicts"
          git push
          ```
          
          ---
          
          ### ‚úÖ Ê™¢Êü•Ê∏ÖÂñÆ
          - [ ] Ëß£Ê±∫Âêà‰ΩµË°ùÁ™Å
          - [ ] Êü•ÁúãËÆäÊõ¥ÂÖßÂÆπ
          - [ ] Ê∏¨Ë©¶ÂäüËÉΩÊòØÂê¶Ê≠£Â∏∏
          - [ ] Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞‰æùË≥¥
          - [ ] Á¢∫Ë™çÊéàÊ¨äÊ¢ùÊ¨æÊú™ËÆäÊõ¥
          
          ---
          ü§ñ Áî± [Check Upstream Updates](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) Ëá™ÂãïÁîüÊàê
          EOF
            
            sed -i 's/^          //' pr_body.md
            
            sed -i "s|CONFLICT_FILES_PLACEHOLDER|${CONFLICT_FILES}|g" pr_body.md
            sed -i "s|BRANCH_NAME_PLACEHOLDER|${{ steps.branch.outputs.branch_name }}|g" pr_body.md
            
          else
            TITLE="‚¨ÜÔ∏è Update ${{ matrix.cog.name }} from upstream"
            LABELS="upstream-update,automated"
            
            cat > pr_body.md <<'EOF'
          ## Ëá™ÂãïÊõ¥Êñ∞ ${{ matrix.cog.name }}
          
          Ê≠§ PR Áî± GitHub Actions Ëá™ÂãïÂâµÂª∫ÔºåÂæû‰∏äÊ∏∏ÂÄâÂ∫´Êõ¥Êñ∞ cog„ÄÇ
          
          **‰∏äÊ∏∏ÂÄâÂ∫´**: ${{ matrix.cog.upstream }}
          **ÂàÜÊîØ**: ${{ steps.check.outputs.upstream_branch }}
          **Ë∑ØÂæë**: ${{ matrix.cog.path }}
          
          ### ‚úÖ Ê™¢Êü•Ê∏ÖÂñÆ
          - [ ] Êü•ÁúãËÆäÊõ¥ÂÖßÂÆπ
          - [ ] Ê∏¨Ë©¶ÂäüËÉΩÊòØÂê¶Ê≠£Â∏∏
          - [ ] Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞‰æùË≥¥
          - [ ] Á¢∫Ë™çÊéàÊ¨äÊ¢ùÊ¨æÊú™ËÆäÊõ¥
          
          ---
          ü§ñ Áî± [Check Upstream Updates](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) Ëá™ÂãïÁîüÊàê
          EOF
            
            sed -i 's/^          //' pr_body.md
          fi
          
          if ! gh pr create \
            --title "${TITLE}" \
            --body-file pr_body.md \
            --base main \
            --head ${{ steps.branch.outputs.branch_name }} \
            --label "${LABELS}"; then
            echo "::error::ÁÑ°Ê≥ïÂâµÂª∫ PR„ÄÇË´ãÁ¢∫Ë™ç Repository Settings > Actions > General > Workflow permissions ‰∏≠Â∑≤ÂãæÈÅ∏ 'Allow GitHub Actions to create and approve pull requests'„ÄÇ"
            exit 1
          fi
          
          if [ "$HAS_CONFLICTS" = "true" ]; then
            echo "::notice::Created PR with merge conflicts that need manual resolution"
          fi

      - name: Report Error
        if: steps.check.outputs.error != ''
        run: |
          echo "::warning::${{ matrix.cog.name }}: ${{ steps.check.outputs.error }}"

  summary:
    runs-on: ubuntu-latest
    needs: check-updates
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "Upstream update check completed!"
          echo "Check the Actions tab for detailed results."
