name: Check Upstream Updates

on:
  schedule:
    # æ¯å¤© UTC 00:00 åŸ·è¡Œï¼ˆå°ç£æ™‚é–“æ—©ä¸Š 8:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  # è®€å–é…ç½®æª”ä¸¦ç”Ÿæˆå‹•æ…‹ matrix
  load-config:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Read upstream-config.yml and generate matrix
        id: set-matrix
        run: |
          # ä½¿ç”¨ yq è§£æ YAML ä¸¦è½‰æ›ç‚º JSON matrix
          # åªåŒ…å«æœªè¢«è¨»è§£çš„ cogs
          MATRIX=$(yq -o=json '.cogs | to_entries | map(select(.value != null)) | map({
            "name": .key,
            "upstream": .value.upstream,
            "path": .value.path,
            "branch": .value.branch
          })' .github/upstream-config.yml | jq -c '{cog: .}')
          
          echo "Generated matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  check-updates:
    runs-on: ubuntu-latest
    needs: load-config
    if: ${{ needs.load-config.outputs.matrix != '' && needs.load-config.outputs.matrix != '{"cog":[]}' }}
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    strategy:
      matrix: ${{ fromJson(needs.load-config.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add Upstream Remote
        id: remote
        run: |
          git remote add upstream-${{ matrix.cog.name }} ${{ matrix.cog.upstream }} 2>/dev/null || true
          
          # å˜—è©¦ fetchï¼Œä¸¦æ•ç²éŒ¯èª¤
          if ! git fetch upstream-${{ matrix.cog.name }} 2>&1; then
            echo "fetch_failed=true" >> $GITHUB_OUTPUT
            echo "::error::Failed to fetch from upstream: ${{ matrix.cog.upstream }}"
            exit 0
          fi
          
          echo "fetch_failed=false" >> $GITHUB_OUTPUT

      - name: Check for Updates
        id: check
        if: steps.remote.outputs.fetch_failed != 'true'
        run: |
          # ä½¿ç”¨é…ç½®æª”ä¸­æŒ‡å®šçš„åˆ†æ”¯ï¼Œå¦‚æœæ²’æœ‰å‰‡è‡ªå‹•åµæ¸¬
          UPSTREAM_BRANCH="${{ matrix.cog.branch }}"
          if [ -z "$UPSTREAM_BRANCH" ]; then
            UPSTREAM_BRANCH=$(git ls-remote --symref upstream-${{ matrix.cog.name }} HEAD | head -n 1 | awk '{print $2}' | sed 's/refs\/heads\///')
            if [ -z "$UPSTREAM_BRANCH" ]; then
              UPSTREAM_BRANCH="main"
            fi
          fi
          
          echo "upstream_branch=$UPSTREAM_BRANCH" >> $GITHUB_OUTPUT
          
          # é©—è­‰åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if ! git rev-parse --verify "upstream-${{ matrix.cog.name }}/$UPSTREAM_BRANCH" >/dev/null 2>&1; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "error=Upstream branch '$UPSTREAM_BRANCH' not found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æª¢æŸ¥ä¸Šæ¸¸è·¯å¾‘æ˜¯å¦å­˜åœ¨
          if ! git ls-tree -r upstream-${{ matrix.cog.name }}/$UPSTREAM_BRANCH --name-only | grep -q "^${{ matrix.cog.path }}/"; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "error=Upstream path not found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ¯”è¼ƒå·®ç•°
          if [ -d "${{ matrix.cog.path }}" ]; then
            DIFF=$(git diff HEAD upstream-${{ matrix.cog.name }}/$UPSTREAM_BRANCH -- ${{ matrix.cog.path }}/ | wc -l)
            if [ "$DIFF" -gt 0 ]; then
              echo "has_updates=true" >> $GITHUB_OUTPUT
            else
              echo "has_updates=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "error=Local path not found" >> $GITHUB_OUTPUT
          fi

      - name: Create Update Branch
        if: steps.check.outputs.has_updates == 'true'
        id: branch
        run: |
          BRANCH_NAME="update/${{ matrix.cog.name }}-$(date +%Y%m%d)"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Merge Upstream Changes
        if: steps.check.outputs.has_updates == 'true'
        id: merge
        continue-on-error: true
        run: |
          # å˜—è©¦åˆä½µä¸Šæ¸¸
          UPSTREAM_BRANCH=${{ steps.check.outputs.upstream_branch }}
          
          echo "Merging changes from upstream..."
          
          # é€™è£¡æˆ‘å€‘ä½¿ç”¨ä¸€å€‹æŠ€å·§ï¼š
          # 1. åŸ·è¡Œ merge (ä¸ commit)
          # 2. å°‡éç›®æ¨™ç›®éŒ„çš„æª”æ¡ˆé‚„åŸåˆ° HEAD
          # 3. æ¸…ç†éç›®æ¨™ç›®éŒ„çš„æœªè¿½è¹¤æª”æ¡ˆ
          
          git merge --no-commit --no-ff --allow-unrelated-histories \
            upstream-${{ matrix.cog.name }}/$UPSTREAM_BRANCH || echo "merge_conflict=true" >> $GITHUB_OUTPUT
          
          echo "Isolating changes to ${{ matrix.cog.path }}..."
          
          # 1. é‡ç½®æš«å­˜å€ (Index)ï¼Œä½†ä¿ç•™å·¥ä½œç›®éŒ„çš„è®Šæ›´
          git reset HEAD
          
          # 2. é‚„åŸæ‰€æœ‰éç›®æ¨™è·¯å¾‘çš„æª”æ¡ˆåˆ° HEAD ç‹€æ…‹
          # ä½¿ç”¨ pathspec exclude :!path
          git checkout HEAD -- . ":!${{ matrix.cog.path }}"
          
          # 3. æ¸…ç†éç›®æ¨™è·¯å¾‘çš„æ–°å¢æª”æ¡ˆ
          # -f: force, -d: directories, -e: exclude pattern
          git clean -fd -e "${{ matrix.cog.path }}/"
          
          # 4. é‡æ–°åŠ å…¥ç›®æ¨™è·¯å¾‘çš„è®Šæ›´
          git add ${{ matrix.cog.path }}/
          
          # æª¢æŸ¥æ˜¯å¦æœ‰è¡çªæ¨™è¨˜ (åœ¨ç›®æ¨™ç›®éŒ„ä¸­)
          if grep -r "^<<<<<<< " ${{ matrix.cog.path }}/; then
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            
            # åˆ—å‡ºæœ‰è¡çªçš„æª”æ¡ˆ
            CONFLICT_FILES=$(grep -l -r "^<<<<<<< " ${{ matrix.cog.path }}/ | tr '\n' ', ' | sed 's/,$//')
            echo "conflict_files=$CONFLICT_FILES" >> $GITHUB_OUTPUT
            
            # æäº¤ä¿ç•™è¡çªå…§å®¹
            git commit -m "âš ï¸ Update ${{ matrix.cog.name }} from upstream (with conflicts)" -m "Conflicts in: $CONFLICT_FILES"
          else
            # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´éœ€è¦æäº¤
            if ! git diff --cached --quiet; then
              echo "has_conflicts=false" >> $GITHUB_OUTPUT
              git commit -m "âœ… Update ${{ matrix.cog.name }} from upstream"
            else
               echo "No effective changes after filtering"
               echo "has_updates=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Push Changes
        if: steps.check.outputs.has_updates == 'true'
        run: |
          git push -f origin ${{ steps.branch.outputs.branch_name }}

      - name: Ensure Labels Exist
        if: steps.check.outputs.has_updates == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh label create upstream-update --color 3fb542 --description "From upstream update" || true
          gh label create automated --color ededed --description "Automated PR" || true
          gh label create merge-conflict --color d73a4a --description "Has merge conflicts" || true

      - name: Create Pull Request
        if: steps.check.outputs.has_updates == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          HAS_CONFLICTS="${{ steps.merge.outputs.has_conflicts }}"
          CONFLICT_FILES="${{ steps.merge.outputs.conflict_files }}"
          
          if [ "$HAS_CONFLICTS" = "true" ]; then
            TITLE="âš ï¸ Update ${{ matrix.cog.name }} from upstream (Conflicts)"
            LABELS="upstream-update,automated,merge-conflict"
            
            cat > pr_body.md <<'EOF'
          ## è‡ªå‹•æ›´æ–° ${{ matrix.cog.name }}
          
          æ­¤ PR ç”± GitHub Actions è‡ªå‹•å‰µå»ºï¼Œå¾ä¸Šæ¸¸å€‰åº«æ›´æ–° cogã€‚
          
          **ä¸Šæ¸¸å€‰åº«**: ${{ matrix.cog.upstream }}
          **åˆ†æ”¯**: ${{ steps.check.outputs.upstream_branch }}
          **è·¯å¾‘**: ${{ matrix.cog.path }}
          
          ## âš ï¸ åˆä½µè¡çª
          
          æ­¤æ›´æ–°åŒ…å«åˆä½µè¡çªï¼Œéœ€è¦æ‰‹å‹•è§£æ±ºã€‚
          
          **è¡çªæª”æ¡ˆ**: CONFLICT_FILES_PLACEHOLDER
          
          ### ğŸ”§ è§£æ±ºæ­¥é©Ÿ
          
          1. Checkout é€™å€‹åˆ†æ”¯ï¼š
          ```bash
          git fetch origin
          git checkout BRANCH_NAME_PLACEHOLDER
          ```
          
          2. è§£æ±ºè¡çªæª”æ¡ˆä¸­çš„è¡çªæ¨™è¨˜ï¼š
             - é–‹å•Ÿæœ‰è¡çªçš„æª”æ¡ˆ
             - å°‹æ‰¾ \`<<<<<<<\`, \`=======\`, \`>>>>>>>\` æ¨™è¨˜
             - æ±ºå®šä¿ç•™å“ªäº›è®Šæ›´
             - ç§»é™¤è¡çªæ¨™è¨˜
          
          3. å®Œæˆè§£æ±ºï¼š
          ```bash
          git add .
          git commit -m "Resolve merge conflicts"
          git push
          ```
          
          ---
          
          ### âœ… æª¢æŸ¥æ¸…å–®
          - [ ] è§£æ±ºåˆä½µè¡çª
          - [ ] æŸ¥çœ‹è®Šæ›´å…§å®¹
          - [ ] æ¸¬è©¦åŠŸèƒ½æ˜¯å¦æ­£å¸¸
          - [ ] æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ä¾è³´
          - [ ] ç¢ºèªæˆæ¬Šæ¢æ¬¾æœªè®Šæ›´
          
          ---
          ğŸ¤– ç”± [Check Upstream Updates](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) è‡ªå‹•ç”Ÿæˆ
          EOF
            
            # å»é™¤æ¯è¡Œé–‹é ­çš„ç¸®æ’ (10å€‹ç©ºæ ¼)ï¼Œä»¥ç¢ºä¿ markdown æ ¼å¼æ­£ç¢º
            sed -i 's/^          //' pr_body.md
            
            sed -i "s|CONFLICT_FILES_PLACEHOLDER|${CONFLICT_FILES}|g" pr_body.md
            sed -i "s|BRANCH_NAME_PLACEHOLDER|${{ steps.branch.outputs.branch_name }}|g" pr_body.md
            
          else
            TITLE="â¬†ï¸ Update ${{ matrix.cog.name }} from upstream"
            LABELS="upstream-update,automated"
            
            cat > pr_body.md <<'EOF'
          ## è‡ªå‹•æ›´æ–° ${{ matrix.cog.name }}
          
          æ­¤ PR ç”± GitHub Actions è‡ªå‹•å‰µå»ºï¼Œå¾ä¸Šæ¸¸å€‰åº«æ›´æ–° cogã€‚
          
          **ä¸Šæ¸¸å€‰åº«**: ${{ matrix.cog.upstream }}
          **åˆ†æ”¯**: ${{ steps.check.outputs.upstream_branch }}
          **è·¯å¾‘**: ${{ matrix.cog.path }}
          
          ### âœ… æª¢æŸ¥æ¸…å–®
          - [ ] æŸ¥çœ‹è®Šæ›´å…§å®¹
          - [ ] æ¸¬è©¦åŠŸèƒ½æ˜¯å¦æ­£å¸¸
          - [ ] æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ä¾è³´
          - [ ] ç¢ºèªæˆæ¬Šæ¢æ¬¾æœªè®Šæ›´
          
          ---
          ğŸ¤– ç”± [Check Upstream Updates](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) è‡ªå‹•ç”Ÿæˆ
          EOF
            
            sed -i 's/^          //' pr_body.md
          fi
          
          # ä½¿ç”¨ gh CLI å‰µå»º PR
          if ! gh pr create \
            --title "${TITLE}" \
            --body-file pr_body.md \
            --base main \
            --head ${{ steps.branch.outputs.branch_name }} \
            --label "${LABELS}"; then
            echo "::error::ç„¡æ³•å‰µå»º PRã€‚è«‹ç¢ºèª Repository Settings > Actions > General > Workflow permissions ä¸­å·²å‹¾é¸ 'Allow GitHub Actions to create and approve pull requests'ã€‚"
            exit 1
          fi
          
          if [ "$HAS_CONFLICTS" = "true" ]; then
            echo "::notice::Created PR with merge conflicts that need manual resolution"
          fi

      - name: Report Error
        if: steps.check.outputs.error != ''
        run: |
          echo "::warning::${{ matrix.cog.name }}: ${{ steps.check.outputs.error }}"

  summary:
    runs-on: ubuntu-latest
    needs: check-updates
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "Upstream update check completed!"
          echo "Check the Actions tab for detailed results."
